# クライアント新規登録テストガイド

**最終更新**: 2025年
**対象**: 修正後のサインアップフロー

---

## 🎯 このドキュメントの目的

修正後のクライアント新規登録フローが正常に動作することを確認するためのテストガイドです。

---

## 🐛 修正した問題

### 修正前の問題

**症状**: 「入力内容を確認してください」というエラーメッセージが表示され、確認コード入力画面に進めない

**原因**: `useValidation` フックの `validateAll` 関数が、存在しない `displayName` フィールドを要求していた

### 修正内容

1. ✅ `useValidation` フックへの依存を削除
2. ✅ フィールドごとの独自バリデーション関数を実装
3. ✅ 各フィールドにエラーメッセージを表示
4. ✅ `console.log` を追加してデバッグしやすく
5. ✅ Cognito エラーハンドリングを改善

---

## 📋 事前準備

### 1. 開発サーバーの起動

```powershell
# ターミナル1: Amplify Sandbox
npx ampx sandbox

# ターミナル2: Next.js Dev Server
npm run dev
```

### 2. ブラウザ開発者ツールを開く

- ブラウザで F12 キーを押す
- Console タブを開いておく（エラーログ確認のため）

### 3. 前回のテストデータをクリア

もし以前に同じメールアドレスでテストしている場合：

```powershell
# AWS Cognito コンソールから削除
# または、別の新しいメールアドレスを使用
```

---

## ✅ テストケース 1: 正常なサインアップフロー

### 入力データ

```
性（姓）: 坂本
名: 将大
メールアドレス: skmtwork0+Test0008@gmail.com
パスワード: TestPass123!
パスワード確認: TestPass123!
```

> **注意**: メールアドレスの `+Test0008` の数字部分を変更して、毎回新しいアドレスを使用してください。

### 手順

1. **サインアップページにアクセス**
   - URL: http://localhost:3000/signup/user

2. **画面確認**
   - ✅ タイトル: 「クライアント新規登録」
   - ✅ 説明: 「サービスを利用する方のアカウント作成」
   - ✅ 入力フィールド: 性（姓）、名、メールアドレス、パスワード、パスワード確認

3. **すべての項目を入力**
   - 上記の入力データを入力

4. **「新規登録」ボタンをクリック**

5. **期待される結果**

   **ブラウザ画面:**
   - ✅ 緑色の成功メッセージ: 「登録が完了しました！確認コード入力画面に移動します。」
   - ✅ 1.5秒後に `/verify?email=skmtwork0+Test0008@gmail.com` へリダイレクト

   **ブラウザコンソール:**
   ```
   ✅ Amplify認証初期化成功
   🔍 サインアップ開始: {lastName: "坂本", firstName: "将大", email: "..."}
   ✅ フロントエンドバリデーション通過
   📤 Cognito signUp 実行中... {username: "...", attributes: {...}}
   ✅ サインアップ成功: {userId: "...", isSignUpComplete: false, ...}
   🔄 /verify へリダイレクト
   ```

6. **確認コード入力画面に遷移**
   - URL: `/verify?email=xxx`
   - 見出し: 「メール確認」
   - メールアドレスが表示されている

7. **テスト成功**

---

## ✅ テストケース 2: 必須フィールド未入力

### 目的

各フィールドが空の場合に、適切なエラーメッセージが表示されることを確認

### 手順

1. **サインアップページにアクセス**
   - URL: http://localhost:3000/signup/user

2. **何も入力せずに「新規登録」ボタンをクリック**

3. **期待される結果**

   各フィールドの下に赤いエラーメッセージが表示される:
   - ✅ 性（姓）: 「性を入力してください」
   - ✅ 名: 「名を入力してください」
   - ✅ メールアドレス: 「メールアドレスを入力してください」
   - ✅ パスワード: 「パスワードを入力してください」
   - ✅ パスワード確認: 「パスワード確認を入力してください」

   画面下部の赤いアラート:
   - ✅ 「入力内容に誤りがあります。各フィールドのエラーメッセージを確認してください。」

4. **各フィールドに入力すると、エラーメッセージが消える**

---

## ✅ テストケース 3: メールアドレス形式エラー

### 手順

1. メールアドレスに不正な形式を入力
   - 例: `test@` （ドメイン部分がない）
   - 例: `test.com` （@がない）

2. 「新規登録」ボタンをクリック

3. **期待される結果**
   - ✅ メールアドレスフィールドの下: 「メールアドレスの形式が正しくありません」

---

## ✅ テストケース 4: パスワード要件エラー

### 手順 4-1: 短すぎるパスワード

1. 入力:
   ```
   パスワード: Test123
   ```

2. 「新規登録」ボタンをクリック

3. **期待される結果**
   - ✅ パスワードフィールドの下: 「パスワードは8文字以上である必要があります」

---

### 手順 4-2: 大文字が含まれていない

1. 入力:
   ```
   パスワード: testpass123!
   ```

2. 「新規登録」ボタンをクリック

3. **期待される結果**
   - ✅ パスワードフィールドの下: 「パスワードには英大文字を含める必要があります」

---

### 手順 4-3: 小文字が含まれていない

1. 入力:
   ```
   パスワード: TESTPASS123!
   ```

2. 「新規登録」ボタンをクリック

3. **期待される結果**
   - ✅ パスワードフィールドの下: 「パスワードには英小文字を含める必要があります」

---

### 手順 4-4: 数字が含まれていない

1. 入力:
   ```
   パスワード: TestPass!
   ```

2. 「新規登録」ボタンをクリック

3. **期待される結果**
   - ✅ パスワードフィールドの下: 「パスワードには数字を含める必要があります」

---

## ✅ テストケース 5: パスワード確認不一致

### 手順

1. 入力:
   ```
   パスワード: TestPass123!
   パスワード確認: TestPass456!
   ```

2. 「新規登録」ボタンをクリック

3. **期待される結果**
   - ✅ パスワード確認フィールドの下: 「パスワードが一致しません」

---

## ✅ テストケース 6: 既存メールアドレス

### 手順

1. 過去にサインアップ済みのメールアドレスを入力
   - 例: `skmtwork0+Test0001@gmail.com`（すでに登録済み）

2. すべての項目を正しく入力して「新規登録」ボタンをクリック

3. **期待される結果**

   **ブラウザ画面:**
   - ✅ 赤いエラーメッセージ: 「このメールアドレスは既に登録されています。別のメールアドレスをお試しください。」

   **ブラウザコンソール:**
   ```
   ❌ Cognito サインアップエラー: UsernameExistsException
   エラー詳細: {name: "UsernameExistsException", message: "...", code: "UsernameExistsException"}
   ```

---

## 📊 テスト結果チェックリスト

| テストケース | 期待結果 | 実際の結果 | 合否 |
|------------|---------|-----------|------|
| 1. 正常なサインアップ | 成功メッセージ表示 → `/verify` へリダイレクト | | ☐ |
| 2. 必須フィールド未入力 | 各フィールドにエラーメッセージ表示 | | ☐ |
| 3. メールアドレス形式エラー | 「メールアドレスの形式が正しくありません」 | | ☐ |
| 4-1. 短すぎるパスワード | 「パスワードは8文字以上である必要があります」 | | ☐ |
| 4-2. 大文字なし | 「パスワードには英大文字を含める必要があります」 | | ☐ |
| 4-3. 小文字なし | 「パスワードには英小文字を含める必要があります」 | | ☐ |
| 4-4. 数字なし | 「パスワードには数字を含める必要があります」 | | ☐ |
| 5. パスワード確認不一致 | 「パスワードが一致しません」 | | ☐ |
| 6. 既存メールアドレス | 「このメールアドレスは既に登録されています...」 | | ☐ |

---

## 🔍 デバッグ用コンソールログ

修正後のコードには、以下のようなコンソールログが出力されます：

### 正常フロー

```
✅ Amplify認証初期化成功
🔍 サインアップ開始: {lastName: "坂本", firstName: "将大", email: "skmtwork0+Test0008@gmail.com"}
✅ フロントエンドバリデーション通過
📤 Cognito signUp 実行中... {username: "skmtwork0+Test0008@gmail.com", attributes: {family_name: "坂本", ...}}
✅ サインアップ成功: {userId: "xxx-xxx-xxx", isSignUpComplete: false, ...}
🔄 /verify へリダイレクト
```

### エラーフロー（バリデーション）

```
✅ Amplify認証初期化成功
🔍 サインアップ開始: {lastName: "", firstName: "", email: ""}
❌ バリデーションエラー: {lastName: "性を入力してください", firstName: "名を入力してください", ...}
```

### エラーフロー（Cognito）

```
✅ Amplify認証初期化成功
🔍 サインアップ開始: {lastName: "坂本", firstName: "将大", email: "existing@example.com"}
✅ フロントエンドバリデーション通過
📤 Cognito signUp 実行中...
❌ Cognito サインアップエラー: UsernameExistsException
エラー詳細: {name: "UsernameExistsException", message: "An account with the given email already exists.", code: "UsernameExistsException"}
```

---

## 🚨 トラブルシューティング

### 問題 1: 「入力内容に誤りがあります」と表示されるが、どこが悪いか分からない

**原因**: フィールドごとのエラーメッセージが表示されていない

**確認方法**:
1. ブラウザコンソール（F12）を開く
2. `❌ バリデーションエラー:` というログを確認
3. どのフィールドにエラーがあるか確認

**解決方法**:
- エラーが表示されているフィールドを修正

---

### 問題 2: サインアップ後、画面が真っ白になる

**原因**: `/verify` ページが存在しない、または Amplify の設定問題

**確認方法**:
1. ブラウザコンソールでエラーメッセージを確認
2. URL が `/verify?email=xxx` になっているか確認

**解決方法**:
- `app/verify/page.tsx` が存在するか確認
- ブラウザのキャッシュをクリア

---

### 問題 3: Cognito エラーが表示されない

**原因**: Amplify Sandbox が起動していない、または設定ミス

**確認方法**:
1. `npx ampx sandbox` が実行されているか確認
2. `amplify_outputs.json` が存在するか確認

**解決方法**:
```powershell
# Sandbox を再起動
npx ampx sandbox
```

---

## 📝 テスト用メールアドレスのバリエーション

Gmail の `+` エイリアス機能を使って、複数のテストアドレスを生成できます：

```
skmtwork0+Test0001@gmail.com
skmtwork0+Test0002@gmail.com
skmtwork0+Test0003@gmail.com
...
skmtwork0+Test0010@gmail.com
```

すべて同じ受信トレイに届きますが、Cognito からは別々のアドレスとして扱われます。

---

## ✅ テスト完了の確認

すべてのテストケースが合格したら、以下を確認してください：

1. ✅ 正常なサインアップが成功し、`/verify` へリダイレクトされる
2. ✅ 各フィールドのバリデーションエラーが適切に表示される
3. ✅ Cognito エラー（既存メールアドレスなど）が日本語で表示される
4. ✅ ブラウザコンソールにデバッグログが出力される

**これらがすべて確認できたら、サインアップフローは正常に動作しています！**

次のステップ: メール確認画面（`/verify`）のテストへ進む

---

## 📞 サポート

問題が解決しない場合は、以下の情報を提供してください：

1. ブラウザコンソールのログ（F12 > Console）のスクリーンショット
2. 入力した値
3. 表示されたエラーメッセージ
4. `amplify_outputs.json` が存在するか
