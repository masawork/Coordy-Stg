# Coordy 認証フロー動作確認手順書（改訂版）

**最終更新日**: 2025年

このドキュメントでは、Coordy アプリケーションの認証フロー全体の動作確認手順をまとめています。

## 📋 更新内容（v2.0）

### 主な変更点

✅ **サインアップ画面**: メール + パスワードのみを入力（氏名・電話番号は `/user/profile/setup` で初回登録）
✅ **確認コード入力画面**: 専用ページを新規作成（`/verify`）
✅ **確認コード再送機能**: ボタンを追加
✅ **リダイレクト先**: サインアップ後は `/verify` へ、確認後は `/login/user` へ
✅ **未確認ユーザー対応**: ログイン時に未確認の場合、自動的に `/verify` へ誘導
✅ **エラーハンドリング**: 日本語化されたわかりやすいエラーメッセージ

> ℹ️ 2025年アップデート: サインアップは「メール + パスワード」だけを受け取り、氏名・住所・電話番号などの個人情報はログイン後の `/user/profile/setup` で1度だけ入力します。以下の手順で旧UIのフィールドが記載されている箇所は、この方針に読み替えてください。

---

## 目次
1. [認証フロー概要](#認証フロー概要)
2. [URL構造とロール対応](#url構造とロール対応)
3. [ブラウザ動作確認手順](#ブラウザ動作確認手順)
4. [トラブルシューティング](#トラブルシューティング)

---

## 認証フロー概要

Coordy は AWS Cognito を使用した認証システムを実装しています。ユーザーは以下の2つのロールに分かれます：

- **クライアント** (`role: 'user'`): サービスを利用する側（学びたい方）
- **クリエイター** (`role: 'instructor'`): サービスを提供する側（教えたい方）

### 認証フロー図（v2.0）

```
┌─────────────────────────────────────────────────────────────┐
│                     新規登録フロー                            │
└─────────────────────────────────────────────────────────────┘

【STEP 1】サインアップ
┌────────────────────────────────┐
│ /signup/user                   │
│ （クライアント新規登録）         │
├────────────────────────────────┤
│ 入力項目:                       │
│ • メールアドレス                │
│ • パスワード                    │
│ • パスワード確認                │
│ （氏名・電話番号は次の          │
│   /user/profile/setup で登録）   │
└────────────────────────────────┘
          ↓
   [Cognito signUp実行]
   • custom:role = 'user'
   • custom:userType = 'CLIENT'
          ↓
   成功メッセージ表示
   「登録が完了しました！確認コード入力画面に移動します。」
          ↓
【STEP 2】メール確認コード入力
┌────────────────────────────────┐
│ /verify?email=xxx@example.com  │
│ （メール確認）                  │
├────────────────────────────────┤
│ 入力項目:                       │
│ • 確認コード（6桁）             │
│                                 │
│ 機能:                           │
│ • 確認コード再送信ボタン        │
│ • ログインページへのリンク      │
└────────────────────────────────┘
          ↓
   [Cognito confirmSignUp実行]
          ↓
   成功メッセージ表示
   「✅ アカウント確認が完了しました！ログイン画面に移動します...」
          ↓
【STEP 3】ログイン
┌────────────────────────────────┐
│ /login/user                    │
│ （クライアントログイン）         │
├────────────────────────────────┤
│ 入力項目:                       │
│ • メールアドレス                │
│ • パスワード                    │
└────────────────────────────────┘
          ↓
   [Cognito signIn実行]
          ↓
   [Roleチェック]
   user.role === 'user' ?
          ↓ YES
   [セッション保存 (localStorage)]
          ↓
【STEP 4】ダッシュボード
┌────────────────────────────────┐
│ /user                          │
│ （クライアントダッシュボード）   │
├────────────────────────────────┤
│ 表示内容:                       │
│ • ウェルカムメッセージ          │
│ • 次の予約（最大3件）           │
│ • 今日のTODO（最大5件）         │
│ • クイックアクション            │
└────────────────────────────────┘


┌─────────────────────────────────────────────────────────────┐
│             未確認ユーザーのログイン試行時の挙動               │
└─────────────────────────────────────────────────────────────┘

/login/user でログイン試行
          ↓
   [Cognito signIn実行]
          ↓
   UserNotConfirmedException エラー発生
          ↓
   エラーメッセージ表示
   「メール確認が完了していません。確認コード入力画面へ移動します...」
          ↓
   2秒後に自動リダイレクト
          ↓
/verify?email=xxx@example.com
```

---

## URL構造とロール対応

### 公開ページ（認証不要）

| URL | 説明 | 実装状況 | 備考 |
|-----|------|---------|------|
| `/` | ランディングページ | ✅ 実装済み | |
| `/signup/user` | クライアント新規登録 | ✅ 実装済み | 性・名を分離入力 |
| `/signup/instructor` | クリエイター新規登録 | ✅ 実装済み | |
| `/verify?email=xxx` | メール確認（確認コード入力） | ✅ 実装済み | 再送機能あり |
| `/login/user` | クライアントログイン | ✅ 実装済み | 未確認ユーザー誘導あり |
| `/login/instructor` | クリエイターログイン | ✅ 実装済み | |

### 保護ページ（認証必要）

| URL | ロール | 説明 | 実装状況 |
|-----|--------|------|---------|
| `/user` | client | クライアントダッシュボード | ✅ 実装済み（実データ表示） |
| `/user/reservations` | client | 予約一覧 | 🚧 未実装 |
| `/user/todos` | client | TODO一覧 | 🚧 未実装 |
| `/user/services` | client | サービス検索 | 🚧 未実装 |
| `/instructor` | creator | クリエイターダッシュボード | ✅ 実装済み |
| `/instructor/services` | creator | サービス管理 | 🚧 未実装 |
| `/instructor/reservations` | creator | 予約管理 | 🚧 未実装 |

---

## ブラウザ動作確認手順

### 事前準備

1. **開発サーバーが起動していることを確認**
   ```powershell
   # ターミナル1: Amplify Sandbox
   npx ampx sandbox

   # ターミナル2: Next.js Dev Server
   npm run dev
   ```

2. **ブラウザを開く**
   - URL: http://localhost:3000
   - 推奨: Chrome、Edge、Firefox（開発者ツールを使用）

3. **ブラウザのキャッシュとlocalStorageをクリア**
   - F12 > Application > Local Storage > http://localhost:3000 > Clear
   - F12 > Console > `localStorage.clear()` を実行

---

### テストケース 1: クライアント新規登録 → メール確認 → ログイン → ダッシュボード（完全フロー）

#### STEP 1-1: クライアント新規登録

1. **サインアップページにアクセス**
   - URL: http://localhost:3000/signup/user

2. **確認ポイント**
   - ✅ 見出し: 「クライアント新規登録」
   - ✅ 説明文: 「サービスを利用する方のアカウント作成」
   - ✅ 背景: 紫〜ピンク〜オレンジのグラデーション

3. **入力項目を確認**
   - ✅ メールアドレス: 入力フィールドあり
   - ✅ パスワード: 入力フィールドあり、ヒント表示あり
   - ✅ パスワード確認: 入力フィールドあり
   - ℹ️ 氏名や電話番号など個人情報の入力欄は存在しない（後続の `/user/profile/setup` で登録）

4. **登録フォームに入力**
   ```
   メールアドレス: test-client-001@example.com
   パスワード: TestPass123!
   パスワード確認: TestPass123!
   ```

5. **「新規登録」ボタンをクリック**

6. **期待される挙動**
   - ✅ Cognito に以下の属性でユーザー登録される:
     - `custom:role`: user
     - `custom:userType`: CLIENT
   - ✅ 成功メッセージ: 「登録が完了しました！確認コード入力画面に移動します。」
   - ✅ 1.5秒後に `/verify?email=test-client-001@example.com` へ自動リダイレクト

7. **エラーが表示された場合**
   - 「このメールアドレスは既に登録されています。」→ 別のメールアドレスを使用
   - 「パスワードは8文字以上で...」→ パスワード要件を満たすように変更

---

#### STEP 1-2: メール確認コード入力

1. **確認コード入力画面が表示される**
   - URL: http://localhost:3000/verify?email=test-client-001@example.com

2. **確認ポイント**
   - ✅ 見出し: 「メール確認」
   - ✅ 説明文: 「test-client-001@example.com 宛に送信された確認コードを入力してください。」
   - ✅ 確認コード入力フィールド: 中央揃え、6桁、大きなフォント
   - ✅ ヒント: 「※ メールに記載された6桁の数字を入力してください」
   - ✅ 「確認コードを再送信」ボタンあり
   - ✅ 「ログインページへ」「トップページへ」リンクあり

3. **メールボックスを確認**
   - **実際のメールサーバーを使用している場合**:
     - `test-client-001@example.com` 宛のメールを確認
     - 差出人: `no-reply@verificationemail.com` または設定したドメイン
     - 件名: 「Your verification code」など
     - 本文に6桁の確認コード記載（例: `123456`）

   - **テスト環境の場合**:
     - AWS Cognito コンソールにログイン
     - ユーザープール > ユーザー で該当ユーザーを検索
     - 確認ステータスを確認（または手動で「確認済み」に変更可能）

4. **確認コードを入力**
   - 例: `123456`（実際にメールで受信したコードを入力）

5. **「確認」ボタンをクリック**

6. **期待される挙動**
   - ✅ Cognito `confirmSignUp` 実行
   - ✅ 成功メッセージ: 「✅ アカウント確認が完了しました！ログイン画面に移動します...」
   - ✅ 2秒後に `/login/user` へ自動リダイレクト

7. **エラーが表示された場合**
   - 「確認コードが正しくありません」→ 再入力、または「確認コードを再送信」をクリック
   - 「確認コードの有効期限が切れています」→ 「確認コードを再送信」をクリック
   - 「このアカウントは既に確認済みです」→ ログインページへ進む

8. **確認コード再送機能のテスト（オプショナル）**
   - 「確認コードを再送信」ボタンをクリック
   - 期待される挙動:
     - ✅ 成功メッセージ: 「✅ 確認コードを再送信しました。メールをご確認ください。」
     - ✅ 新しい確認コードがメールで送信される

---

#### STEP 1-3: クライアントログイン

1. **ログインページが表示される**
   - URL: http://localhost:3000/login/user

2. **確認ポイント**
   - ✅ 見出し: 「クライアントログイン」
   - ✅ 説明文: 「学びたい方のログイン」

3. **ログイン情報を入力**
   ```
   メールアドレス: test-client-001@example.com
   パスワード: TestPass123!
   ```

4. **「ログイン」ボタンをクリック**

5. **期待される挙動**
   - ✅ Cognito `signIn` 実行
   - ✅ ロールチェック成功（role === 'user'）
   - ✅ セッション保存（localStorage）:
     - `coordy_session`: "true"
     - `coordy_user`: `{"userId":"xxx","email":"test-client-001@example.com","name":"田中 一郎","role":"user",...}`
   - ✅ `/user` ダッシュボードへ自動リダイレクト

6. **エラーが表示された場合**
   - 「メールアドレスまたはパスワードが正しくありません」→ 入力情報を確認
   - 「このメールアドレスは登録されていません」→ サインアップから始める

---

#### STEP 1-4: クライアントダッシュボード確認

1. **ダッシュボードが表示される**
   - URL: http://localhost:3000/user

2. **確認ポイント（ヘッダー）**
   - ✅ 左上: 「Coordy」ロゴ
   - ✅ 右上: 「田中 一郎さん」
   - ✅ 右上: 「クライアント」バッジ（紫色）

3. **確認ポイント（メインコンテンツ）**
   - ✅ ウェルカムセクション（紫〜ピンクグラデーション）:
     - 「ようこそ、田中 一郎さん！」
     - 「今日も素晴らしい一日にしましょう」

   - ✅ 次の予約カード:
     - 見出し: 「次の予約」
     - データがない場合: 「予約はまだありません」
     - データがある場合: 予約情報表示（日時、ステータス）

   - ✅ 今日のTODOカード:
     - 見出し: 「今日のTODO」
     - データがない場合: 「TODOはまだありません」
     - データがある場合: TODO情報表示（タイトル、優先度バッジ）

   - ✅ クイックアクションカード:
     - 「サービスを探す」ボタン
     - 「TODOを追加」ボタン

4. **ブラウザをリロード（F5）**
   - 期待される挙動:
     - ✅ セッションが維持される（再ログイン不要）
     - ✅ ダッシュボードが再表示される

5. **開発者ツールで確認（F12）**
   - Application > Local Storage > http://localhost:3000
   - 確認ポイント:
     - ✅ `coordy_session`: "true"
     - ✅ `coordy_user`: JSON形式でユーザー情報が保存されている

---

### テストケース 2: 未確認ユーザーのログイン試行

このテストケースでは、サインアップ後にメール確認をスキップした場合の挙動を確認します。

#### STEP 2-1: 未確認ユーザーでログイン試行

1. **前提**:
   - サインアップは完了しているが、メール確認（`confirmSignUp`）が未実施のユーザー
   - 例: `test-client-002@example.com`

2. **ログインページにアクセス**
   - URL: http://localhost:3000/login/user

3. **ログイン情報を入力**
   ```
   メールアドレス: test-client-002@example.com
   パスワード: TestPass123!
   ```

4. **「ログイン」ボタンをクリック**

5. **期待される挙動**
   - ✅ Cognito `signIn` 実行
   - ✅ `UserNotConfirmedException` エラーが発生
   - ✅ エラーメッセージ表示: 「メール確認が完了していません。確認コード入力画面へ移動します...」
   - ✅ 確認画面へのリンク表示: 「→ 確認コード入力画面へ」
   - ✅ 2秒後に `/verify?email=test-client-002@example.com` へ自動リダイレクト

6. **確認コード入力画面へ遷移**
   - STEP 1-2 と同じ手順で確認コードを入力して確認完了

---

### テストケース 3: ロールベースのアクセス制御

#### STEP 3-1: クライアントでクリエイターページへアクセス

1. **クライアントでログイン**
   - URL: http://localhost:3000/login/user
   - ログイン: `test-client-001@example.com` / `TestPass123!`

2. **クリエイターダッシュボードへ直接アクセス**
   - ブラウザのアドレスバーに入力: http://localhost:3000/instructor

3. **期待される挙動**
   - ✅ アクセスが拒否される
   - ✅ `/user` ダッシュボードへ自動リダイレクト

---

### テストケース 4: 異なるロールでのログイン試行

#### STEP 4-1: クライアントアカウントでクリエイターログイン

1. **クリエイターログインページにアクセス**
   - URL: http://localhost:3000/login/instructor

2. **クライアントの認証情報を入力**
   ```
   メールアドレス: test-client-001@example.com
   パスワード: TestPass123!
   ```

3. **「ログイン」ボタンをクリック**

4. **期待される挙動**
   - ✅ Cognito認証は成功するが、ロールチェックで拒否
   - ✅ エラーメッセージ: 「クリエイターアカウントでログインしてください」
   - ❌ ログインできない

---

## トラブルシューティング

### 問題 1: サインアップ後に TOP ページにリダイレクトされてしまう

**原因**: コードが古いバージョンのまま
**解決方法**: 最新の `app/signup/user/page.tsx` に差し替え、リダイレクト先が `/verify?email=xxx` になっていることを確認

---

### 問題 2: 確認コード入力画面が表示されない（404エラー）

**原因**: `/verify` ページが存在しない
**解決方法**: `app/verify/page.tsx` を作成

---

### 問題 3: 確認コードが届かない

**原因**: AWS Cognito の設定、またはメールサーバーの問題

**解決方法**:
1. **AWS Cognito コンソールで確認**
   - ユーザープール > メッセージング > メール設定
   - SES設定が正しいか確認

2. **迷惑メールフォルダを確認**

3. **手動で確認済みに変更**
   - AWS Cognito コンソール > ユーザープール > ユーザー
   - 該当ユーザーを選択 > 「アクション」 > 「メールアドレスの確認」

---

### 問題 4: ログイン時に「UserNotConfirmedException」が延々と出る

**原因**: メール確認が完了していない

**解決方法**:
1. `/verify` ページで正しい確認コードを入力
2. または AWS Cognito コンソールで手動確認

---

### 問題 5: localStorage にセッションが保存されない

**原因**: ブラウザの設定、またはプライベートモード

**確認手順**:
1. ブラウザがプライベートモード/シークレットモードでないか確認
2. ブラウザの設定で Cookie/Storage が無効になっていないか確認
3. F12 > Console で `localStorage.setItem('test', 'value')` を実行し、エラーが出ないか確認

---

### 問題 6: 「性」と「名」を入力しても Cognito に反映されない

**原因**: Cognito カスタム属性の設定ミス、またはコードの問題

**確認手順**:
1. `app/signup/user/page.tsx` で `family_name` と `given_name` が正しく設定されているか確認
2. AWS Cognito コンソール > ユーザープール > ユーザー属性 で `family_name` と `given_name` が有効になっているか確認

---

## まとめ

この改訂版では、以下の機能が正常に動作することを確認できます：

✅ **クライアント新規登録**（性・名を分離入力）
✅ **メール確認コード入力**（専用画面、再送機能付き）
✅ **クライアントログイン**（未確認ユーザー自動誘導）
✅ **ダッシュボードアクセス**（実データ表示）
✅ **セッション永続化**（ブラウザリロード後も維持）
✅ **ロールベースのアクセス制御**
✅ **エラーハンドリング**（日本語化、わかりやすいメッセージ）

---

## パスワードリセットフロー

ユーザーがパスワードを忘れた場合のリセット手順です。

```
┌────────────────────────────────────────────────────────────┐
│              パスワードリセットフロー                        │
└────────────────────────────────────────────────────────────┘

【STEP 1】パスワードリセット申請
┌────────────────────────────────┐
│ /login/user                    │
│ （ログインページ）               │
├────────────────────────────────┤
│ リンク:                         │
│ 「パスワードをお忘れの方はこちら」│
└────────────────────────────────┘
          ↓ クリック
┌────────────────────────────────┐
│ /login/user/forgot             │
│ （パスワードリセット申請）       │
├────────────────────────────────┤
│ 入力項目:                       │
│ • メールアドレス                │
│                                 │
│ ボタン:                         │
│ • リセットメールを送信          │
└────────────────────────────────┘
          ↓
   [Cognito resetPassword実行]
   • 登録されているメールアドレスに確認コード送信
          ↓
   成功メッセージ表示
   「✓ メールを送信しました」
          ↓
【STEP 2】新しいパスワードの設定
┌────────────────────────────────┐
│ /login/user/reset              │
│ （パスワードリセット）           │
├────────────────────────────────┤
│ 入力項目:                       │
│ • メールアドレス                │
│ • 確認コード（6桁）             │
│ • 新しいパスワード              │
│ • パスワード確認                │
└────────────────────────────────┘
          ↓
   [Cognito confirmResetPassword実行]
          ↓
   成功メッセージ表示
   「✓ パスワードを変更しました」
          ↓
【STEP 3】ログイン
┌────────────────────────────────┐
│ /login/user                    │
│ 新しいパスワードでログイン      │
└────────────────────────────────┘
```

### パスワードリセットの確認手順

1. ログインページにアクセス：`http://localhost:3000/login/user`
2. 「パスワードをお忘れの方はこちら」リンクをクリック
3. メールアドレスを入力して「リセットメールを送信」をクリック
4. メールボックスを確認し、確認コードを取得
5. リセットページで確認コードと新しいパスワードを入力
6. 「パスワードを設定」をクリック
7. ログインページへ自動遷移
8. 新しいパスワードでログイン

### パスワード要件

- 8文字以上
- 英大文字を1文字以上含む
- 英小文字を1文字以上含む
- 数字を1文字以上含む

### エラーハンドリング

- **`UserNotFoundException`**: 「このメールアドレスは登録されていません。」
- **`CodeMismatchException`**: 「確認コードが正しくありません。」
- **`ExpiredCodeException`**: 「確認コードの有効期限が切れています。もう一度リセットメールを送信してください。」
- **`InvalidPasswordException`**: 「パスワードが要件を満たしていません。8文字以上で、大文字・小文字・数字を含めてください。」
- **`LimitExceededException`**: 「リクエスト回数の上限に達しました。しばらく時間をおいてからお試しください。」

---

## 次のステップ

認証フローが完全に動作したら、以下の機能実装に進むことができます：

**Phase 2: ユーザー機能**
- サービス検索ページ（`/user/services`）
- TODO管理ページ（`/user/todos`）
- 予約一覧ページ（`/user/reservations`）
- サービス詳細＆予約機能

**Phase 3: クリエイター機能**
- サービス管理ページ（`/instructor/services`）
- 予約管理ページ（`/instructor/reservations`）
- プロフィール編集ページ（`/instructor/profile`）

---

## 変更履歴

### v3.0 (2025年)
- パスワードリセット機能を追加
  - パスワードリセット申請ページ（`/login/user/forgot`）
  - パスワードリセット実行ページ（`/login/user/reset`）
  - ログインページに「パスワードをお忘れの方はこちら」リンクを追加

### v2.0 (2025年)
- サインアップ画面で性・名を分離入力
- 確認コード入力画面を新規作成（`/verify`）
- 確認コード再送機能を追加
- リダイレクト先を修正（サインアップ後 → `/verify`、確認後 → `/login/user`）
- ログイン時の未確認ユーザー対応を追加
- エラーメッセージを日本語化

### v1.0
- 初版作成
- 基本的な認証フロー記載
